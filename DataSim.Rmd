---
title: "Data Simulation -  with 10 dataset and 1 set probabilities p"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reshape)
```

```{r}
# a utility function, inverse-logit transform
expit<-function (mu)
{
    1/((1/exp(mu)) + 1)
}
```



```{r}
"gf.temp" <-
  structure(c(17.3, 16.5, 19, 19.7, 18.6, 16.2, 17.8, 20, 18.6, 
              17.1, 8.6, 8.3, 7.5, 6.4, 6.4, 6.8, 6.4, 7.3, 6.8, 6.9, 6.4, 
              5.8, 6, 5.6, 6.3, 6, 6.4, 6.9, 6.5, 7, 10, 10, 10, 10, 10, 10, 
              10, 8.88888888888889, 8.88888888888889, 7.22222222222222, 11.1111111111111, 
              10, 8.88888888888889, 8.88888888888889, 8.88888888888889, 8.88888888888889, 
              7.77777777777778, 7.77777777777778, 7.77777777777778, 7.77777777777778, 
              7.3, 6.9, 7.9, 8.4, 7.5, 7, 6.4, 6.5, 5.1, 3.8, 10.5, 10.5, 10.5, 
              10.1, 10.1, 9.8, 8.8, 9.8, 10.1, 12.4, 11.7, 10.2, 9.9, 10.5, 
              9.2, 9.3, 9.7, 9.9, 9.8, 9.6, 7.22222222222222, 6.66666666666667, 
              7.22222222222222, 8.33333333333333, 7.22222222222222, 6.66666666666667, 
              5.55555555555556, 5.55555555555556, 5.55555555555556, 5, 7.22222222222222, 
              7.22222222222222, 7.22222222222222, 7.22222222222222, 7.22222222222222, 
              7.22222222222222, 7.22222222222222, 7.22222222222222, 7.22222222222222, 
              7.22222222222222, 6.11111111111111, 6.11111111111111, 6.11111111111111, 
              6.11111111111111, 6.11111111111111, 5.55555555555556, 5.55555555555556, 
              5.55555555555556, 5.55555555555556, NA, 16.8333333333333, 16.5555555555556, 
              16.7222222222222, 16.4444444444444, 13.7222222222222, 14, 13.8888888888889, 
              13.7222222222222, 13.7777777777778, 13.8888888888889, NA, NA, 
              NA, NA, NA, NA, NA, NA, NA, NA, 11.1111111111111, 11.1111111111111, 
              11.1111111111111, 10, 10, 9.44444444444444, 10, 10, 10, 10, 14.8, 
              14.9, 15, 14.9, 15.6, 15.7, 15.3, 17.1, 15.6, 15.8, 8.7, 9, 12.5, 
              5, 7.6, 7.5, 8.8, 8, 6.8, 6.5, 8.8, 8.8, 10.4, 10.1, 10.2, 10.7, 
              10.8, 10.2, 10.4, 9.5, 8.9, 10.2, 6.8, 4, 6.8, 4.3, 4.1, 4.1, 
              8.3, 4.9, 7.22222222222222, 7.22222222222222, 6.66666666666667, 
              6.66666666666667, 6.66666666666667, 5.55555555555556, 5.55555555555556, 
              3.88888888888889, 4.44444444444444, 4.44444444444444, 6.6, 6.3, 
              6.3, 5.8, 6.3, 6.3, 6.1, 6.1, 6, 6.1, 7.6, 7.5, 7.5, 7.5, 7.6, 
              7.4, 7.5, 7.6, 7.6, 6.9, 16.6666666666667, 16.6666666666667, 
              21.1111111111111, 19.4444444444444, 18.3333333333333, 18.3333333333333, 
              18.3333333333333, 16.6666666666667, 16.6666666666667, 16.6666666666667, 
              20.2, 18.8, 16.3, 17.1, 18.7, 18.8, 17.9, 17.4, 17.6, 17.1, 16.5, 
              19.7, 14.4, 14.7, 12.5, 17.4, 16.1, 13, 13.8, 14.7, 12.5, 10.6, 
              11.8, 10.3, 10, 9.9, 10.6, 12.7, 11.3, 11.1, 23.8888888888889, 
              23.8888888888889, 23.8888888888889, 23.3333333333333, 23.3333333333333, 
              22.7777777777778, 22.7777777777778, 22.2222222222222, 22.2222222222222, 
              22.2222222222222, 25.5555555555556, 23.3333333333333, 22.7777777777778, 
              22.2222222222222, 21.1111111111111, 20.5555555555556, 20, 20, 
              20, 20, 14.7, 15.1, 14.3, 14.3, 13.6, 14.8, 13.9, 13.9, 12.9, 
              11.8, 17.4, 16.2, 14.4, 14.2, 14.2, 14.1, 14.2, 14.2, 14.2, 14.2, 
              13.7, 14.4, 12.8, 16.1, 14.2, 14, 13, 11.9, 12.2, 11.6, 18.3333333333333, 
              17.7777777777778, 17.7777777777778, 17.7777777777778, 17.7777777777778, 
              17.2222222222222, 16.6666666666667, 16.6666666666667, 16.1111111111111, 
              16.1111111111111, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 23.3333333333333, 
              23.3333333333333, 23.3333333333333, 23.3333333333333, 20, 20, 
              20, 20, 20, 22.2222222222222, 16.6111111111111, 17.5, 13.8888888888889, 
              15.1111111111111, 11.2777777777778, 11.1111111111111, 13, 14.2777777777778, 
              11.7222222222222, 12.7777777777778, 17.9, 18.4, 19.4, 19.5, 18, 
              17.7, 18, 18, 17.9, 16.7, 21.6666666666667, 21.1111111111111, 
              20.5555555555556, 22.7777777777778, 23.3333333333333, 22.2222222222222, 
              21.1111111111111, 22.7777777777778, 22.2222222222222, 18.8888888888889, 
              12.4, 12.5, 13.6, 13.9, 13, 11.1, 13.4, 12.2, 13.5, 12.1, 23, 
              20.8, 19.3, 17.6, 15.3, 18.4, 17.8, 18.4, 18.4, 18.6, 21.6, 21, 
              21.1, 20.6, 19.6, 21.9, 19.3, 18.5, 18.6, 18.7, NA, NA, NA, NA, 
              NA, NA, NA, NA, NA, NA, 13.8888888888889, 12.2222222222222, 10, 
              10, 10, 9.44444444444444, 11.6666666666667, 12.2222222222222, 
              10.5555555555556, 10.5555555555556, 16.6, 13.3, 12.8, 13.5, 12.1, 
              12.7, 16.2, 15.8, 15, 11.3, 10.8, 13.4, 10.1, 13, 14.4, 12.6, 
              13, 11.3, 13.7, 10.7, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 
              20.7, 20.6, 19.5, 20.1, 19.4, 20.3, 19.8, 20.1, 20.1, 20.1, 18.9, 
              18.2, 19.9, 18.7, 18.7, 18.6, 19.4, 19.1, 19.6, 19.6, 26.2, 21.8, 
              21.4, 20.5, 20.2, 20.9, 21.7, 21.5, 21.6, 21.2, 26.6666666666667, 
              26.6666666666667, 26.6666666666667, 26.6666666666667, 26.6666666666667, 
              26.6666666666667, 26.6666666666667, 26.6666666666667, 26.6666666666667, 
              26.6666666666667, 25.5555555555556, 22.2222222222222, 22.2222222222222, 
              22.2222222222222, 22.2222222222222, 22.7777777777778, 22.2222222222222, 
              23.3333333333333, 24.4444444444444, 24.4444444444444, 23.3333333333333, 
              NA, NA, NA, NA, NA, NA, NA, NA, 22.7777777777778, 23.2, 23.2, 
              23.1, 23.2, 23, 22, 22.4, 22.4, 22.4, 22.4, 21.4, 21.4, 20.7, 
              20.8, 20.6, 19.5, 19.8, 19.9, 19.4, 20.4, NA, NA, NA, NA, NA, 
              NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, 
              NA, NA, NA, NA, NA, NA, NA, NA, NA, 27.2222222222222, 27.7777777777778, 
              27.2777777777778, 26.3888888888889, 27.2222222222222, 27.3888888888889, 
              25.2222222222222, 25.7777777777778, 24.7222222222222, 25.2222222222222, 
              23.1, 23, 23.5, 28.7, 23.9, 25.7, 24.4, 23.1, 24.3, 23.9, 22.2222222222222, 
              24.4444444444444, 25.5555555555556, 23.3333333333333, 21.6666666666667, 
              21.1111111111111, 24.4444444444444, 23.8888888888889, 22.7777777777778, 
              20, 19.6, 19.6, 18.7, 22, 21.7, 16.9, 21.1, 19.4, 20.3, 20.6, 
              20.6, 19.5, 18.6, 16.2, 18.7, 18.4, 18.6, 19.3, NA, 18, 17.5, 
              15.4, 15.7, 15.9, 14.7, 16.3, 14, 15.6, 15.5, 16.5, 27.4, 25.2, 
              24.1, 26.7, 25.3, 26, 27.4, 23.9, 23.8, 24.1, 21.1111111111111, 
              20, 20, 18.3333333333333, 20, 18.3333333333333, 21.1111111111111, 
              20, 18.3333333333333, 19.4444444444444, 16.4, 16.5, 16.2, 16.2, 
              15.7, 15.6, 15.5, 15.8, 16.2, 15, 20.7, 20.7, 21.3, 22.1, 21, 
              21.7, 22, 22.5, 21.9, 22.2, 26.6666666666667, 26.6666666666667, 
              25.5555555555556, 24.4444444444444, 24.4444444444444, 25, 25.5555555555556, 
              25, 25, 24.4444444444444), .Dim = as.integer(c(220, 3)), .Dimnames = list(
                structure(c("460503", "460503", "460503", "460503", "460503", 
                            "460503", "460503", "460503", "460503", "460503", "460203", 
                            "460203", "460203", "460203", "460203", "460203", "460203", 
                            "460203", "460203", "460203", "460704", "460704", "460704", 
                            "460704", "460704", "460704", "460704", "460704", "460704", 
                            "460704", "460708", "460708", "460708", "460708", "460708", 
                            "460708", "460708", "460708", "460708", "460708", "460505", 
                            "460505", "460505", "460505", "460505", "460505", "460505", 
                            "460505", "460505", "460505", "460706", "460706", "460706", 
                            "460706", "460706", "460706", "460706", "460706", "460706", 
                            "460706", "460107", "460107", "460107", "460107", "460107", 
                            "460107", "460107", "460107", "460107", "460107", "460108", 
                            "460108", "460108", "460108", "460108", "460108", "460108", 
                            "460108", "460108", "460108", "460104", "460104", "460104", 
                            "460104", "460104", "460104", "460104", "460104", "460104", 
                            "460104", "460205", "460205", "460205", "460205", "460205", 
                            "460205", "460205", "460205", "460205", "460205", "460304", 
                            "460304", "460304", "460304", "460304", "460304", "460304", 
                            "460304", "460304", "460304", "460307", "460307", "460307", 
                            "460307", "460307", "460307", "460307", "460307", "460307", 
                            "460307", "460405", "460405", "460405", "460405", "460405", 
                            "460405", "460405", "460405", "460405", "460405", "460407", 
                            "460407", "460407", "460407", "460407", "460407", "460407", 
                            "460407", "460407", "460407", "460501", "460501", "460501", 
                            "460501", "460501", "460501", "460501", "460501", "460501", 
                            "460501", "460504", "460504", "460504", "460504", "460504", 
                            "460504", "460504", "460504", "460504", "460504", "460508", 
                            "460508", "460508", "460508", "460508", "460508", "460508", 
                            "460508", "460508", "460508", "460603", "460603", "460603", 
                            "460603", "460603", "460603", "460603", "460603", "460603", 
                            "460603", "460604", "460604", "460604", "460604", "460604", 
                            "460604", "460604", "460604", "460604", "460604", "460703", 
                            "460703", "460703", "460703", "460703", "460703", "460703", 
                            "460703", "460703", "460703", "460803", "460803", "460803", 
                            "460803", "460803", "460803", "460803", "460803", "460803", 
                            "460803", "460804", "460804", "460804", "460804", "460804", 
                            "460804", "460804", "460804", "460804", "460804"), .Dim = as.integer(220)), 
                c("1", "2", "3")))
```




```{r}
# a utility function, inverse-logit transform
expit<-function (mu)
{
    1/((1/exp(mu)) + 1)
}
```




```{r}
nSites = 10
nVisits = 3

#psi
psival_sim = c(0.101076257,0.009025875,0.775309078,0.114588790)
nClasses = 4
#psi = abs(rnorm(nClasses))
#psi = psi/sum(psi)

#S - true value 
S = rmultinom(nSites,1,psival_sim)
S
#N -
N = apply(S==1,MARGIN = 2, FUN = which)
N

```

```{r}
# Y1 -  observed values. 
detMat <- matrix(NA, nrow = nClasses, ncol = nClasses)
detMat[1,] <- c(1,0,0,0) # hard-coded for now
detMat[2,] <- c(0.2689414,0.7310586,0,0)
detMat[3,] <- c(0.40878724,0.09121276,0.50000000,0)
detMat[4,] <- c(0.33421401,0.07457323,0.09121276,0.50000000)
#print(detMat)

M1 = matrix(NA, nrow = nSites, ncol = nVisits)
#detMat
for (i in 1:nSites)
{
  #print(detMat[N[i],])
  temp <- rmultinom(nVisits,1,detMat[N[i],])
  #print(temp)
  M1[i,] = apply(temp==1,MARGIN = 2,FUN = which )
  #print(Y1)
}
print(M1)
#print(ncol(M1))
```



```{r}
#Data - M
temp <- gf.temp
temp <- temp-mean(temp,na.rm=T)


```


```{r}
negloglik<-function(x,pim,vars=NULL){
  vars = NULL
  nparm<-length(unique(pim))
               ##### Need help with this part #####
 
  psi<-x[(nparm+1):(nparm+3)]
  psi<-exp(c(0,psi))/sum( exp(c(0,psi)))  #multinomial logit
  
  #psigraph <- psi - psival_sim
  
  #print(psigraph)
  
  
  if(length(vars)>0){
    covparms<-x[ (nparm+4):length(x)]
    names(covparms)<-vars
    tempparms<-c(0,0,0,0)
    names(tempparms)<-c("time1","time3","temp1","temp2")
    tempparms[vars]<-covparms
    time1<-tempparms[1]
    time3<-tempparms[2]
    temp1<-tempparms[3]
    temp2<-tempparms[4]
  }
  else{
    time1<-time3<-temp1<-temp2<-0
  }
  x<-x[pim]
  beta1<-expit(x[4])
  beta2<-expit(x[5])
  beta3<-expit(x[6])
  
  cs<-rep(NA,nrow(M1))
  
  
  #psigraph <<- rep(NA,nrow(M1),3)
  for(i in 1:nrow(M1)){ # nsites R
   
    lik<-matrix(NA,nrow=4,ncol=ncol(M1))
    for(j in 1:ncol(M1)){ # nvisits T
      
      p1<-expit(x[1]+time1*ifelse(j==1,1,0) +time3*ifelse(j==3,1,0) + temp1*temp[i,j] + temp2*temp[i,j]*temp[i,j])
      p2<-expit(x[2]+time1*ifelse(j==1,1,0) +time3*ifelse(j==3,1,0) + temp1*temp[i,j] + temp2*temp[i,j]*temp[i,j])
      p3<-expit(x[3]+time1*ifelse(j==1,1,0) +time3*ifelse(j==3,1,0) + temp1*temp[i,j] + temp2*temp[i,j]*temp[i,j])
      c2<-c(1-p1,p1)
      c3<-c((1-beta1)*(1-p2),beta1*(1-p2),p2)
      c4<-c( (1-beta3)*(1-beta2)*(1-p3),(1-beta3)*beta2*(1-p3),beta3*(1-p3),p3)
      P<-matrix(0,4,4)
      P[1,1]<-1
      P[1:2,2]<-c2
      P[1:3,3]<-c3
      P[1:4,4]<-c4
      #print(P)
      if(!is.na(M1[i,j])){
        # probabilities of observed value for each N=0,1,2,3 state
        this.p<-  P[M1[i,j], ]
        lik[,j]<- this.p
      }
      else{
        lik[,j]<-1
      }
    }
    cs[i]<-sum(apply(lik,1,prod)*psi) # prod over visits, sum over k=0,1,2,3
    
    
  }
 
-2*sum(log(cs)) # sum over log of site probabilities
  
}
```

 


```{r}
#Parameter index vector
#print(psigraph)
PIM<-c(1,1,1,2,2,2)
#startipointng 
st<-c(-1, -2, -1.5, -0.4,-1.2, -2, -2, 2,0)

#Non Linear Minimization

out2 <- nlm(negloglik,st,pim=PIM,vars=c("time1","time3","temp1"),hessian=T)
out2

#verification with psi
psi1<-exp(c(0,out2$estimate[7:9]))/sum( exp(c(0,out2$estimate[7:9])))  #multinomial logit
psi1
psigraph = psi1 - psival_sim
print(psigraph)
sum(psi1)
#print(psigraph)


```

```{r}
 kk = 0.10499359+0.01420934+0.77580349+0.10499359
 

```

